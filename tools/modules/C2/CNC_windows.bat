@echo off

set OpenSSHInstallerPath=C:\Downloads\OpenSSHInstaller.msi
set Username=meu_usuario
set Password=minha_senha

REM Verificar se o arquivo MSI do OpenSSH existe
if exist "%OpenSSHInstallerPath%" (
    REM Instalar o servidor SSH usando o arquivo MSI
    msiexec.exe /i "%OpenSSHInstallerPath%" /qn

    REM Verificar se o caminho do executável do servidor SSH existe
    set SSHExecutable=C:\Windows\System32\OpenSSH\sshd.exe
    if exist "%SSHExecutable%" (
        echo O servidor SSH foi instalado com sucesso.
        echo Caminho do executável: %SSHExecutable%

        REM Gerar a chave SSH
        echo Gerando a chave SSH...
        ssh-keygen -t rsa -N "" -f "%USERPROFILE%\.ssh\id_rsa"

        REM Criar o usuário da chave SSH com senha
        echo Criando o usuário da chave SSH...
        powershell -Command ^
            "$User = New-LocalUser -Name %Username% -NoPassword;" ^
            "$Password = ConvertTo-SecureString '%Password%' -AsPlainText -Force;" ^
            "$User | Set-LocalUser -Password $Password -PasswordNeverExpires:$true -UserMayNotChangePassword:$true"

        echo Usuário e chave SSH criados com sucesso.
    ) else (
        echo Falha ao encontrar o executável do servidor SSH.
        echo Verifique se o OpenSSH foi instalado corretamente.
    )
) else (
    echo O arquivo MSI do OpenSSH não foi encontrado.
    echo Verifique o caminho fornecido: %OpenSSHInstallerPath%
)