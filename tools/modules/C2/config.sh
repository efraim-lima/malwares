#!/bin/bash

source .env

# Criar arquivo de serviço
echo "[Unit]
Description=Netcat Server
After=network.target

[Service]
Type=simple
Restart=always
ExecStart=bash -c 'if ! nc -z -v -w5 localhost 2222; then nc -lvp 2222 | tee -a output.txt; fi'

[Install]
WantedBy=multi-user.target" > "$SERVICE_FILE"

echo "[Unit]
Description=Netcat Timer

[Timer]
OnBootSec=5min
OnUnitActiveSec=5min

[Install]
WantedBy=timers.target
" > "$SERVICE_TIMER"

# Recarregar serviços do systemd
sudo systemctl daemon-reload

# Iniciar e habilitar o serviço nc
sudo systemctl unmask nc.service
sudo systemctl start nc.service
sudo systemctl enable nc.service
sudo systemctl unmask nc.timer
sudo systemctl start nc.timer
sudo systemctl enable nc.timer

echo "Configuração do serviço Netcat concluída."