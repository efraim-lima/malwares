#!/bin/bash

sudo apt-get update
sudo apt-get install autossh

# Configurações do túnel SSH
subdominio_duckdns="seu_subdominio"  # Subdomínio que você criou no DuckDNS
porta_local="8080"  # Porta local que você deseja encaminhar o tráfego
porta_remota="80"   # Porta no host remoto que você deseja acessar (por exemplo, 80 para HTTP)
usuario_remoto="seu_usuario"  # Seu nome de usuário no servidor remoto
servidor_remoto="seu_subdominio.duckdns.org"  # Nome do subdomínio DuckDNS

# Função para obter o endereço IP atual usando o DuckDNS
obter_endereco_ip_atual() {
  endereco_ip=$(curl -s https://ipinfo.io/ip)
  echo $endereco_ip
}

# Função para estabelecer o túnel SSH usando o "autossh"
estabelecer_tunel() {
  echo "Estabelecendo o túnel SSH com autossh..."
  autossh -M 0 -N -o "ServerAliveInterval 30" -L $porta_local:$servidor_remoto:$porta_remota $usuario_remoto@$servidor_remoto
}

# Verificar e atualizar o endereço IP no DuckDNS
novo_endereco_ip=$(obter_endereco_ip_atual)
antigo_endereco_ip=$(dig +short $servidor_remoto)
if [ "$novo_endereco_ip" != "$antigo_endereco_ip" ]; then
  echo "Atualizando o endereço IP do subdomínio DuckDNS..."
  curl "https://www.duckdns.org/update?domains=$subdominio_duckdns&token=seu_token&ip=$novo_endereco_ip"
fi

# Estabelecer o túnel SSH
estabelecer_tunel
