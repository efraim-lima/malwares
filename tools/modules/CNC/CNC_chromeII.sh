#!/bin/bash

apt install -y openssh-server

username=$(whoami)
usernameb="play"
ssh_port="22" # Porta SSH (padrão é 22)
ssh_dir="/home/$username/.ssh"
ssh_key="$ssh_dir/id_rsa"
output_file="ssh_info.txt"

# Criação de um novo usuário
useradd -m -s /bin/bash $usernameb
passwd $usernameb

# Define as permissões corretas para a chave
chown -R $username:$username $ssh_dir
chmod 700 $ssh_dir
chmod 600 $ssh_key*

# Configuração do acesso remoto via SSH
sed -i "s/#Port 22/Port $ssh_port/" /etc/ssh/sshd_config
sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config
sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
echo "AllowUsers $usernameb" >> /etc/ssh/sshd_config

# Reinicia o serviço SSH
systemctl restart ssh

# Exporta informações para o arquivo de saída
output_path="/home/$username/$output_file"
echo "Chave SSH: $ssh_key" > $output_path
echo "Nome de usuário: $usernameb" >> $output_path
echo "IP da máquina: $(hostname -I)" >> $output_path

echo "Chave SSH criada com sucesso. As informações foram exportadas para o arquivo $output_file."
echo "Agora você pode acessar sua máquina remotamente via terminal usando:"
echo "ssh -p $ssh_port $usernameb@$(hostname -I)"

# Criação da chave SSH
mkdir -p $ssh_dir
ssh-keygen -t rsa -b 4096 -f $ssh_key -N ""