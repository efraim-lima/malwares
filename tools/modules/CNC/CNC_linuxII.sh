#!/bin/bash

# Function to install FreeRDP if not already installed
install_freerdp() {
    local package_manager

    if command -v apt &> /dev/null; then
        package_manager="apt"
    elif command -v yum &> /dev/null; then
        package_manager="yum"
    elif command -v dnf &> /dev/null; then
        package_manager="dnf"
    elif command -v zypper &> /dev/null; then
        package_manager="zypper"
    else
        echo "Unsupported package manager. Please install FreeRDP manually and try again."
        exit 1
    fi

    echo "Installing FreeRDP..."
    sudo "$package_manager" install -y freerdp
}

# Function to check if FreeRDP is installed
check_freerdp() {
    if ! command -v xfreerdp &> /dev/null; then
        install_freerdp
        exit 1
    fi
}

# Function to get the local IP address
get_local_ip() {
    local_ip=$(ip -o -4 addr show scope global | awk '{split($4, a, "/"); print a[1]}')
    echo "$local_ip"
}

# Function to send an email alert
send_alert_email() {
    local recipient="test@test.com"
    local subject="IP Address Alert"
    local body="The current local IP address is: $(get_local_ip)"
    echo "$body" | mail -s "$subject" "$recipient"
}

# Function to connect to the RDP server
connect_rdp() {
    local server="$1"
    local username="$2"
    local password="$3"

    echo "Connecting to RDP server: $server..."
    xfreerdp /v:"$server" /u:"$username" /p:"$password"
}

# Main function
main() {

    # Check and install FreeRDP if needed
    check_freerdp

    # Set RDP server details
    local rdp_server="YOUR_RDP_SERVER_IP_OR_HOSTNAME"
    local rdp_username="YOUR_RDP_USERNAME"
    local rdp_password="YOUR_RDP_PASSWORD"

    # Collect and send the local IP address as an alert
    send_alert_email

    # Connect to the RDP server
    connect_rdp "$rdp_server" "$rdp_username" "$rdp_password"
}

# Run the main function
main
