@echo off
setlocal

rem Baixar arquivos necessários para o funcionamento do SSH (caso ainda não existam)
if not exist "C:\Program Files\OpenSSH\ssh-keygen.exe" (
    echo Baixando o pacote OpenSSH...
    curl -o OpenSSH-Win64.zip https://github.com/PowerShell/Win32-OpenSSH/releases/download/v8.0.0.0p1-Beta/OpenSSH-Win64.zip
    tar -xf OpenSSH-Win64.zip
    copy OpenSSH-Win64\ssh-keygen.exe "C:\Program Files\OpenSSH\"
    del OpenSSH-Win64.zip
    rmdir /s /q OpenSSH-Win64
)

rem Defina as configurações do host SSH
set "UserName=play"          rem Substitua pelo nome de usuário desejado
set "Password=play"           rem Substitua pela senha do usuário
set "SshPublicKey=chave_ssh.pub"   rem Substitua pelo caminho completo do arquivo da chave pública SSH

rem Crie um novo usuário local no Windows
net user %UserName% %Password% /add /passwordchg:no /expires:never

rem Adicione o usuário ao grupo Administradores (opcional, pode não ser necessário)
net localgroup Administrators %UserName% /add

rem Crie o diretório .ssh no perfil do usuário (se não existir)
if not exist "C:\Users\%UserName%\.ssh" (
    mkdir "C:\Users\%UserName%\.ssh"
)

rem Copie a chave pública SSH para o diretório .ssh (se ainda não existir)
if not exist "C:\Users\%UserName%\.ssh\authorized_keys" (
    copy "%SshPublicKey%" "C:\Users\%UserName%\.ssh\authorized_keys"
)

rem Defina as permissões corretas para o diretório .ssh e o arquivo authorized_keys
icacls "C:\Users\%UserName%\.ssh" /inheritance:r /grant "%UserName%:(OI)(CI)(RX)"
icacls "C:\Users\%UserName%\.ssh\authorized_keys" /grant "%UserName%:(RX)"

rem Reinicie o serviço SSH (serviço "OpenSSH SSH Server")
net stop sshd
net start sshd

echo Configuração do host SSH concluída!
pause
