#!/bin/bash

### SUPER IMPORTANTE!!!

# # Para usar o nome de usuário "joao" e a porta padrão (22)
# sudo ./setup_chromebook.sh joao yes

### SUPER IMPORTANTE!!!

source .env

# Instalar o servidor SSH
sudo apt-get update
sudo apt-get install -y openssh-server

# Ativar encaminhamento de porta na configuração do servidor SSH
sudo sed -i "/^#*GatewayPorts/c\GatewayPorts yes" /etc/ssh/sshd_config

# Reiniciar o serviço SSH
sudo service ssh restart

# Configurar variáveis
usuario_servidor="seu_usuario"
porta_reversa=2222

# Verificar e gerar chave SSH, caso necessário
if [ ! -f ~/.ssh/id_rsa.pub ]; then
    ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
fi

# Obter sua chave pública SSH
sua_chave=$(cat ~/.ssh/id_rsa.pub)

# Obter seu IP público usando registros DNS
seu_ip=$(dig +short myip.opendns.com @resolver1.opendns.com)

# Enviar chave e outras informações para a máquina remota
ssh $SERVER_USERNAME@seu_ip_remoto "echo \"$SERVER_USERNAME:$sua_chave\" > chave_ssh.txt"
echo "Chave pública SSH enviada para a máquina remota."

# Enviar comando para iniciar configuração na máquina remota
ssh $SERVER_USERNAME@seu_ip_remoto "bash -s" < configurar_remoto.sh
echo "Configuração iniciada na máquina remota."