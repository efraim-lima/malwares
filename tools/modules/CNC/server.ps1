function Install-OpenVPN {
    # Instalação do OpenVPN (chocolatey é um gerenciador de pacotes para Windows)
    if (-Not (Test-Path 'C:\Program Files\OpenVPN')) {
        Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
    }
    choco install openvpn -y
}

function Configure-OpenVPN-Server {
    # Configuração do OpenVPN
    $IP_PUBLICO_AMIGO = Read-Host "Digite o endereço IP público ou o subdomínio que aponta para o computador do seu amigo"
    $PORTA_OPENVPN = Read-Host "Digite a porta do servidor OpenVPN (recomendado: 1194)"
    $PROTOCOLO_OPENVPN = Read-Host "Digite o protocolo do servidor OpenVPN (recomendado: udp)"

    # Criação do arquivo de configuração do servidor
    @"
local 0.0.0.0
port $PORTA_OPENVPN
proto $PROTOCOLO_OPENVPN
dev tun
ca ca.crt
cert server.crt
key server.key
dh dh.pem
server 10.8.0.0 255.255.255.0
ifconfig-pool-persist ipp.txt
push "redirect-gateway def1 bypass-dhcp"
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 8.8.4.4"
keepalive 10 120
comp-lzo
persist-key
persist-tun
status openvpn-status.log
verb 3
cipher AES-256-CBC
"@ | Out-File -FilePath "C:\Program Files\OpenVPN\config\server.conf" -Encoding utf8

    # Verificar se o diretório config já existe
    $configPath = "C:\Program Files\OpenVPN\config"
    if (-Not (Test-Path $configPath)) {
        New-Item -ItemType Directory -Force -Path $configPath
    }

    # Salvar os certificados no diretório config
    Copy-Item "C:\Program Files\OpenVPN\ca.crt" -Destination $configPath
    Copy-Item "C:\Program Files\OpenVPN\issued\server.crt" -Destination $configPath
    Copy-Item "C:\Program Files\OpenVPN\private\server.key" -Destination $configPath
    Copy-Item "C:\Program Files\OpenVPN\dh.pem" -Destination $configPath
}

function Start-OpenVPN-Server {
    # Iniciar o OpenVPN
    Start-Process "C:\Program Files\OpenVPN\bin\openvpn.exe" -ArgumentList "--config C:\Program Files\OpenVPN\config\server.conf"
}

# Script principal
Install-OpenVPN
Configure-OpenVPN-Server
Start-OpenVPN-Server