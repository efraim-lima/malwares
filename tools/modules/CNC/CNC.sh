#!/bin/bash

#Antes de iniciar todo o processo
# chmod +x CNC.sh

sudo apt-get update
sudo apt-get install -y ssmtp

# Coleta dinâmica do IP público
IP_PUBLICO=$(curl -s ifconfig.me)

# Criação do nome de usuário
read -p "Digite o nome de usuário para o SSH: " USUARIO_SSH

# Criação da variável de porta de túnel reverso
read -p "Digite a porta para o túnel reverso (exemplo: 2222): " PORTA_TUNEL_REVERSO

# Armazenando os comandos para o acesso remoto em uma variável
COMANDOS_ACESSO_REMOTO="echo 'Acesso Remoto:'
# Exemplo de comando para ler arquivo:
cat /caminho/para/arquivo.txt
# Exemplo de comando para salvar arquivo:
echo 'Conteúdo do arquivo' > /caminho/para/novo_arquivo.txt
# Exemplo de comando para editar arquivo:
echo 'Mais conteúdo' >> /caminho/para/arquivo_existente.txt
# Exemplo de comando para baixar arquivo:
wget URL_DO_ARQUIVO
# Exemplo de comando para deletar arquivo:
rm /caminho/para/arquivo_para_deletar.txt"

# Enviando as informações para o e-mail
echo -e "IP Público: $IP_PUBLICO\nNome de Usuário SSH: $USUARIO_SSH\nPorta do Túnel Reverso: $PORTA_TUNEL_REVERSO\nComandos para Acesso Remoto:\n$COMANDOS_ACESSO_REMOTO" | ssmtp teste@teste.com

# Verifica se o SSH está instalado e, se não, instala
sudo apt-get update
sudo apt-get install -y openssh-server

# Configura o SSH para aceitar conexões de outras máquinas
sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
sudo systemctl restart ssh

# Cria o túnel reverso
ssh -N -R $PORTA_TUNEL_REVERSO:localhost:22 $USUARIO_SSH@$IP_PUBLICO

# Para adicionar o script à inicialização do sistema, siga os passos abaixo:

# Mova o script CNC.sh para um local permanente, como /usr/local/bin:
sudo mv CNC.sh /usr/local/bin/

echo "Adicione a linha abaixo logo acima da linha exit 0 no arquivo /etc/rc.local para chamar o script na inicialização:
# /usr/local/bin/CNC.sh
# Salve e feche o arquivo rc.local."

# Abra o arquivo de inicialização do sistema /etc/rc.local:
sudo nano /etc/rc.local

while true; do
    read comando
    case $comando in
        "status")
            echo "Sistema funcionando normalmente."
            ;;
        "dados")
            echo "Aqui estão os dados solicitados..."
            ;;
        "encerrar")
            echo "Encerrando o sistema."
            break
            ;;
        *)
            echo "Comando não reconhecido."
            ;;
    esac
done